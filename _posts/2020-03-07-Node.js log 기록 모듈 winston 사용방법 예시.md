---
layout: post
title: Node.js log 기록 모듈 winston 사용방법 예시
tags: [node.js, winston, npm, log]
comments: true
---
node.js로 프로젝트를 진행하면서 log를 기록하기 위해 npm 모듈을 알아보던 중 winston이라는 모듈을 발견했다. 예시와 함께 설명이 잘되어 있으며 사용방법도 간편하고 무엇보다 인기가 많은 모듈이라 선택했다.

[참고한 블로그](https://basketdeveloper.tistory.com/42)에 적힌 예시와 [npm winston](https://www.npmjs.com/package/winston)를 참고하면서 나름대로의 log.js 파일을 만들어봤다.

### 1. 필요한 모듈 설치
{% highlight shell %}
npm i -s winston
npm i -s winston-daily-rotate-file
npm i -s moment-timezone
{% endhighlight %}
winston모듈 이외에 2개의 모듈이 더 있는데 winston-daily-rotate-file 모듈은 날짜별로 로그 파일을 생성할 수 있으며 파일 용량의 제한을 두거나 오래된 log파일을 알아서 제거해주는 편리한 모듈이다. 그리고  winston의 timezone은 기본적으로 UTC이기 때문에 한국 시간을 기록하기 위해 moment-timezone 모듈을 사용하여 timezone을 서울로 대체한다.

### 2. moment.js 파일을 생성하여 타임존 한국시간으로 설정
{% highlight js %}
const moment = require("moment-timezone");
moment.tz.setDefault("Asia/Seoul");
module.exports = moment;
{% endhighlight %}

### 3. log.js 파일을 생성하여 winston 함수 및 포맷 정의
{% highlight js %}
// 위에서 작성한 moment.js 모듈을 불러온다.
const moment = require('./moment');
const winston = require('winston');
require('winston-daily-rotate-file');

// winston의 사용할 함수들
const { addColors, createLogger, transports, format } = winston;
const { combine, label, printf, colorize } = format;

// log파일이 기록될 폴더 경로 (프로젝트의 루트가 기준)
const LOG_DIR = './logs';

/*
 * 로그 레벨 : { emerg: 0, alert: 1, crit: 2, error: 3, warning: 4, notice: 5, info: 6, debug: 7 }
 */

// 레벨 별 출력 color를 취향에 맞게 설정
addColors({
    error: 'red',
    warn: 'yellow',
    info: 'cyan',
    debug: 'green'
});

// 로그 출력 포맷 정의
const logFormat = printf(({ level, message, label, timestamp }) => {
    return `${timestamp} [${label}] ${level}: ${message}`;
});

// 타임존이 서울인 moment를 사용하여 타임스탬프 포맷 정의
const timestamp = format((info) => {
    info.timestamp = moment().format('YYYY-MM-DD, hh:mm:ss a');
    return info;
});
{% endhighlight %}
<center>출력 예시</center>
{% highlight shell %}
2020-03-07, 04:39:15 pm [라벨이름] info: 로그를 출력합니다.
{% endhighlight %}


### 4. log 파일, 콘솔 transport 옵션 설정
{% highlight js %}
// 날짜 별로 생성될 로그 파일의 옵션 설정
const dailyRotateFileTransport = new transports.DailyRotateFile({
    level: "info", // info 레벨부터 로그를 남긴다. (debug 레벨은 찍히지 않는다)
    filename: `${LOG_DIR}/%DATE%.log`, //./logs/2020-03-07.log
    datePattern: "YYYY-MM-DD",
    zippedArchive: true, // archive된 파일 압축 여부, 디폴트는 false
    maxSize: "20m",  // 파일 당 최대 크기를 20mb로 설정
    maxFiles: "30d", // 최근 30일간의 파일만 유지, 오래된 파일은 zippedArchive 설정에 따라 삭제 혹은 압축된다.
    format: combine(
        label({ label: '라벨이름' }),
        timestamp(),  // 위에서 생성했던 타임스태프 포맷을 사용한다.
        logFormat // 위에서 생성했던 로그 출력 포맷 형식을 사용한다.
    )
});

// 로그의 콘솔 출력 옵션 설정
const consoleTransport = new transports.Console({
    level: 'debug',
    handleExceptions: true,
    json: true,
    colorize: true,
    format: combine(
        label({ label: '라벨이름' }),
        timestamp(),
        colorize({ all: true }), // 컬러 출력
        logFormat
    )
});
{% endhighlight %}

### 5. 로거 생성
{% highlight js %}
const logger = new createLogger({
    transports: [
        dailyRotateFileTransport
    ],
    exitOnError: false,
});

// 개발 시 콘솔 출력
if (process.env.NODE_ENV !== 'production') {
    logger.add(consoleTransport)
};

module.exports = logger;
{% endhighlight %}

### 6. log.js 최종
{% highlight js %}
const moment = require('./moment');
const winston = require('winston');
require('winston-daily-rotate-file');

const { addColors, createLogger, transports, format } = winston;
const { combine, label, printf, colorize } = format;
const LOG_DIR = './logs';

addColors({
    error: 'red',
    warn: 'yellow',
    info: 'cyan',
    debug: 'green'
});

const logFormat = printf(({ level, message, label, timestamp }) => {
    return `${timestamp} [${label}] ${level}: ${message}`;
});

const timestamp = format((info) => {
    info.timestamp = moment().format('YYYY-MM-DD, hh:mm:ss a');
    return info;
});

const dailyRotateFileTransport = new transports.DailyRotateFile({
    level: "info",
    filename: `${LOG_DIR}/%DATE%.log`,
    datePattern: "YYYY-MM-DD",
    zippedArchive: true,
    maxSize: "20m",
    maxFiles: "30d",
    colorize: true,
    format: combine(
        label({ label: '라벨이름' }),
        timestamp(),
        colorize({ all: true }),
        logFormat
    )
});

const consoleTransport = new transports.Console({
    level: 'debug',
    handleExceptions: true,
    json: true,
    colorize: true,
    format: combine(
        label({ label: '라벨이름' }),
        timestamp(),
        colorize({ all: true }),
        logFormat
    )
});

const logger = new createLogger({
    transports: [
        dailyRotateFileTransport
    ],
    exitOnError: false,
});

if (process.env.NODE_ENV !== 'production') {
    logger.add(consoleTransport)
};

module.exports = logger;

{% endhighlight %}

### 7. 사용
{% highlight js %}
const logger = require('./log');
logger.info('로그를 출력합니다.');
logger.debug('로그를 출력합니다.');
logger.error('로그를 출력합니다.');
logger.warn('로그를 출력합니다.');
{% endhighlight %}

### 결과
<img src="/public/images/2020-03-07-Node.js log 기록 모듈 winston 사용방법 예시/콘솔 로그.png" style="margin: 0px auto;" width="100%" height="30%" title="콘솔 로그" alt="콘솔 로그"/>

**로그 파일 생성도 잘 된 것을 볼 수 있다**
<img src="/public/images/2020-03-07-Node.js log 기록 모듈 winston 사용방법 예시/로그 파일.png" width="35%" height="25%" title="로그 파일" alt="로그 파일"/>

지금까지 winston을 활용하여 로그를 파일로 남기는 작업을 간단히 진행해봤다.  
나도 공부하면서 정리해놓는 거라 미숙한 부분이 많지만 도움 받는 부분이 있다면 좋겠다.  
그리고 예시는 뼈대일 뿐이니 여기에 살을 붙여나가면 된다.